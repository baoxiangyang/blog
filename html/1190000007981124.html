b开发，基本上都是使用<code>NoSQL</code>数据库，最频繁的就是使用<a href="https://www.mongodb.com/">MongoDB</a>了，自己做了一些简单的Web开发，为了降低学习门槛，一直使用<code>MySQL</code>来做数据库。这里简单介绍一下连接<code>MySQL</code>数据库的方式，希望能帮助到其他人。</p>
<pre><code>npm install --save mysql</code></pre>
<p>使用上述命令安装完<code>MySQL</code>的模块后，就可以直接使用了，官网的DOCS里一个简单的例子如下就可以入门了。</p>
<pre><code class="js">var mysql = require('mysql');
var connection = mysql.createConnection({
  host: 'localhost',
  user: 'me',
  password : 'secret',
  database : 'my_db'
});
connection.connect();
connection.query('SELECT 1 + 1 AS solution', function(err, rows, fields) {
  if (err) throw err;
  console.log('The solution is: ', rows[0].solution);
});
connection.end();</code></pre>
<p>很简单的一个例子，从上面的例子可以得出：使用<code>createConnection(option)</code>方法创建一个连接对象，然后连接对象的<code>connect()</code>方法创建连接，最后使用<code>query()</code>方法执行SQL语句，返回结果作为回调函数的参数<code>rows</code>返回，<code>rows</code>为数组类型。</p>
<h3>1. 连接</h3>
<p>创建连接对象，需要传入连接数据库的一些连接参数，也就是<code>createConnection(option)</code>里的<code>option</code>，<code>option</code>是一个对象，以键值对的形式传入<code>createConnection()</code>方法里。上例列举出了最基本的参数：</p>
<ul>
<li><p><code>host</code> 主机名</p></li>
<li><p><code>user</code> 连接数据库的用户</p></li>
<li><p><code>password</code> 密码</p></li>
<li><p><code>database</code> 数据库名称</p></li>
</ul>
<p>还有其他的参数，可以查询下官方DOCS，这里不一一列举了，初期学习上面这些参数就足以。</p>
<h3>2. 关闭</h3>
<p>关闭一个连接使用<code>end()</code>方法，<code>end()</code>方法提供一个回调函数，如下：</p>
<pre><code class="js">connect.end(function(err){
    console.log('End a connection');
});</code></pre>
<p>这是建议使用的方法，<code>end()</code>方法会等待连接回调完成后才关闭连接。官方还提供了另外一种方法<code>destroy()</code>方法，这个方法直接关闭连接，不会等待回调完成。</p>
<p>举个简单的例子：</p>
<pre><code class="js">var mysql = require('mysql');
var option = require('./connect.js').option;
var conn = mysql.createConnection(option);
conn.query('select * from message',function(err,rows,fields){
  if(!err){
    console.log(rows);
  }
});
conn.end(function(err){
  console.log('end a connection');
});</code></pre>
<p>最终结果会是：先打印完<code>SELECT</code>数据表结果后，再打印<code>end a connection</code>。而如果你将关闭方法换成<code>conn.destroy();</code>，那么你就别想返回任何结果了，因为还没等回调结束就已经终止连接了。</p>
<h3>3. 连接池</h3>
<p>连接池的原理是一开始就给你创建多个连接对象放在一个“池子”里，用的时候取一个，用完了放回“池子”里，在一定程度上是有利于节省系统开销的，因为连接对象是在最开始的时候就创建好了，使用的时候不再需要系统开销去创建数据库连接对象。官方DOCS介绍了连接方法：</p>
<pre><code class="js">var mysql = require('mysql');
var pool  = mysql.createPool({
  connectionLimit : 10,
  host            : 'example.org',
  user            : 'bob',
  password        : 'secret',
  database        : 'my_db'
});
pool.query('SELECT 1 + 1 AS solution', function(err, rows, fields) {
  if (err) throw err;
  console.log('The solution is: ', rows[0].solution);
});</code></pre>
<p>创建连接池的方法是<code>createPool(option)</code>，<code>option</code>里多了一个参数<code>connectionLimit</code>指的是一次性在连接池里创建多少个连接对象，默认10个。如果你想共享一个连接对象，可以使用下面方法进行连接；</p>
<pre><code class="js">var mysql = require('mysql');
var pool  = mysql.createPool({
  host     : 'example.org',
  user     : 'bob',
  password : 'secret',
  database : 'my_db'
});
pool.getConnection(function(err, connection) {
  // Use the connection
  connection.query( 'SELECT something FROM sometable', function(err, rows) {
    // And done with the connection.
    connection.release();
    // Don't use the connection here, it has been returned to the pool.
  });

// Use the connection
  connection.query( 'SELECT something2 FROM sometable2', function(err, rows) {
    // And done with the connection.
    connection.release();
    // Don't use the connection here, it has been returned to the pool.
  });
});</code></pre>
<p>使用一个连接对象执行两次<code>query()</code>函数。</p>
<h3>4. 示例1</h3>
<p>使用基本的连接方式来连接数据库，分别定义数据连接以及关闭的<code>function</code>，如下示例：</p>
<pre><code class="js">// connect.js 数据库连接与关闭
var mysql = require('mysql');
var config = require('./config.json'); // 将数据库连接参数写入mysql对象，即config.mysql
var connCount = 0; // 统计目前未关闭的连接
exports.getConn = function(){
  connCount ++;
  console.log('............................OPEN a connection, has '+ connCount + ' connection.');
  return mysql.createConnection(config.mysql);
};
exports.endConn = function(conn){
  conn.end(function(err){
    if(!err){
      connCount --;
      console.log('.........................CLOSE a connection, has '+ connCount + ' connection.');
    }
  });
};</code></pre>
<p>然后给个使用数据库的示例，</p>
<pre><code class="js">// db.js 查询用户信息
var connect = require('./connect.js'); // 引入数据连接方法
exports.getUser = function(username, callback){
    var connection = connect.getConn();
    var sql = 'select * from user where username = "' + username + '"';
    connection.query(sql,function(err,rows,fields){
        callback(err,rows,fields);    
    });
    connect.endConn(connection);
}</code></pre>
<h3>5. 示例2</h3>
<p>使用数据库连接池，同样先创建数据库连接池的方法，如下两种方式：</p>
<pre><code class="js">// connect.js 直接使用
var mysql = require('mysql');
var config = require('./config.json');
var pool = mysql.createPool(config.mysql);

exports.querySQL = function(sql,callback){
    pool.query(sql, function(err,rows,fields){
        callback(err,rows,fields);
    });
}</code></pre>
<pre><code class="js">// connect.js 使用getConnection方法
var mysql = require('mysql');
var config = require('./config.json');
var pool = mysql.createPool(config.mysql);

exports.querySQL = function(sql, callback){
    pool.getConnection(function(err,conn){
        conn.query(sql,function(err,rows,fields){
            callback(err,rows,fields); 
            conn.release();   // 不要忘了释放
        });        
    });
}</code></pre>
<p>使用的时候，直接使用<code>querySQL</code>方法即可，如下：</p>
<pre><code class="js">// db.js 查询用户信息
var connect = require('./connect.js');
exports.getUser = function(username,callback){
    var sql = 'select * from user where username = "' + username + '"';
    connect.querySQL(sql,function(err,rows,fields){
        callback(err,rows,fields);        
    });
};</code></pre>
<p>官方是推荐使用连接池的方式进行连接的，但是，是直接使用<code>pool.query()</code>连接还是<code>pool.getConnection()</code>的方法来连接，官方并没有介绍其优劣，我简单做了个测试，貌似这两种方式并没有多大的区别，也就没再研究，有知