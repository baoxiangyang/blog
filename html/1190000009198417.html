<p>本文摘录自《Nodejs学习笔记》，更多章节及更新，请访问 <a href="https://github.com/chyingp/nodejs-learning-guide">github主页地址</a>。欢迎加群交流，群号 <a href="http://shang.qq.com/wpa/qunwpa?idkey=7e4f670e1cd9278f30003965a1cc068a4f30d8c73aa071c8da189f4842dbbee6">197339705</a>。</p></blockquote>
<h2>模块概览</h2>
<p>readline是个非常实用的模块。如名字所示，主要用来实现逐行读取，比如读取用户输入，或者读取文件内容。常见使用场景有下面几种，本文会逐一举例说明。本文相关代码可在笔者<a href="https://github.com/chyingp/nodejs-learning-guide/tree/master/examples/2016.12.15-readline">github</a>上找到。</p>
<ul>
<li><p>文件逐行读取：比如说进行日志分析。</p></li>
<li><p>自动完成：比如输入npm，自动提示"help init install"。</p></li>
<li><p>命令行工具：比如npm init这种问答式的脚手架工具。</p></li>
</ul>
<h2>基础例子</h2>
<p>先看个简单的例子，要求用户输入一个单词，然后自动转成大写</p>
<pre><code class="js">const readline = require('readline');

const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
});

rl.question('Please input a word: ', function(answer){
    console.log('You have entered {%s}', answer.toUpperCase());
    rl.close();
});</code></pre>
<p>运行如下：</p>
<pre><code class="bash">➜  toUpperCase git:(master) ✗ node app.js 
Please input a word: hello
You have entered {HELLO}</code></pre>
<h2>例子：文件逐行读取：日志分析</h2>
<p>比如我们有如下日志文件access.log，我们想要提取“访问时间+访问地址”，借助<code>readline</code>可以很方便的完成日志分析的工作。</p>
<pre><code>[2016-12-09 13:56:48.407] [INFO] access - ::ffff:127.0.0.1 - - "GET /oc/v/account/user.html HTTP/1.1" 200 213125 "http://www.example.com/oc/v/account/login.html" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.98 Safari/537.36"
[2016-12-09 14:00:10.618] [INFO] access - ::ffff:127.0.0.1 - - "GET /oc/v/contract/underlying.html HTTP/1.1" 200 216376 "http://www.example.com/oc/v/account/user.html" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.98 Safari/537.36"
[2016-12-09 14:00:34.200] [INFO] access - ::ffff:127.0.0.1 - - "GET /oc/v/contract/underlying.html HTTP/1.1" 200 216376 "http://www.example.com/oc/v/account/user.html" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.98 Safari/537.36"</code></pre>
<p>代码如下：</p>
<pre><code class="js">const readline = require('readline');
const fs = require('fs');

const rl = readline.createInterface({
    input: fs.createReadStream('./access.log')
});

rl.on('line', (line) =&gt; {
    const arr = line.split(' '); 
    console.log('访问时间：%s %s，访问地址：%s', arr[0], arr[1], arr[13]);
});</code></pre>
<p>运行结果如下：</p>
<pre><code class="bash">➜  lineByLineFromFile git:(master) ✗ node app.js
访问时间：[2016-12-09 13:56:48.407]，访问地址："http://www.example.com/oc/v/account/login.html"
访问时间：[2016-12-09 14:00:10.618]，访问地址："http://www.example.com/oc/v/account/user.html"
访问时间：[2016-12-09 14:00:34.200]，访问地址："http://www.example.com/oc/v/account/user.html"</code></pre>
<h2>例子：自动完成：代码提示</h2>
<p>这里我们实现一个简单的自动完成功能，当用户输入npm时，按tab键，自动提示用户可选的子命令，如help、init、install。</p>
<ul>
<li><p>输入<code>np</code>，按下tab：自动补全为npm</p></li>
<li><p>输入<code>npm in</code>，按下tab：自动提示可选子命令 init、install</p></li>
<li><p>输入<code>npm inst</code>，按下tab：自动补全为 <code>npm install</code></p></li>
</ul>
<pre><code class="js">const readline = require('readline');
const fs = require('fs');

function completer(line) {
    const command = 'npm';
    const subCommands = ['help', 'init', 'install'];

    // 输入为空，或者为npm的一部分，则tab补全为npm
    if(line.length &lt; command.length){
        return [command.indexOf(line) === 0 ? [command] : [], line];
    }

    // 输入 npm，tab提示 help init install
    // 输入 npm in，tab提示 init install
    let hits = subCommands.filter(function(subCommand){ 
        const lineTrippedCommand = line.replace(command, '').trim();
        return lineTrippedCommand &amp;&amp; subCommand.indexOf( lineTrippedCommand ) === 0;
    })

    if(hits.length === 1){
        hits = hits.map(function(hit){
            return [command, hit].join(' ');
        });
    }
  
    return [hits.length ? hits : subCommands, line];
}

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout,
  completer: completer
});

rl.prompt();</code></pre>
<p>代码运行效果如下，当输入<code>npm in</code>，按下tab键，则会自动提示可选子命令init、install。</p>
<pre><code class="bash">➜  autoComplete git:(master) ✗ node app.js
&gt; npm in
init     install  </code></pre>
<h2>例子：命令行工具：npmt init</h2>
<p>下面借助readline实现一个迷你版的<code>npm init</code>功能，运行脚本时，会依次要求用户输入name、version、author属性（其他略过）。</p>
<p>这里用到的是<code>rl.question(msg, cbk)</code>这个方法，它会在控制台输入一行提示，当用户完成输入，敲击回车，<code>cbk</code>就会被调用，并把用户输入作为参数传入。</p>
<pre><code class="js">const readline = require('readline');
const fs = require('fs');
const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
    prompt: 'OHAI&gt; '
});

const preHint = `
This utility will walk you through creating a package.json file.
It only covers the most common items, and tries to guess sensible defaults.

See \`npm help json\` for definitive documentation on these fields
and exactly what they do.

Use \`npm install &lt;pkg&gt; --save\` afterwards to install a package and
save it as a dependency in the package.json file.

Press ^C at any time to quit.
`;

console.log(preHint);

// 问题
let questions = [ 'name', 'version', 'author'];

// 默认答案
let defaultAnswers = [ 'name', '1.0.0', 'none' ];

// 用户答案
let answers = [];
let index = 0;

function createPackageJson(){
    var map = {};
    questions.forEach(function(question, index){
        map[question] = answers[index];
    });

    fs.writeFileSync('./package.json', JSON.stringify(map, null, 4));
}

function runQuestionLoop() {

    if(index === questions.length) {
        createPackageJson();
        rl.close();
        return;
    }
    
    let defaultAnswer = defaultAnswers[index];
    let question = questions[index] + ': (' + defaultAnswer +') ';
    
    rl.question(question, function(answer){
        answers.push(answer || defaultAnswer);
        index++;
        runQuestionLoop();
    });
}

runQuestionLoop();</code></pre>
<p>运行效果如下，最后还像模像样的生成了package.json（害羞脸）。</p>
<pre><code class="bash">➜  commandLine git:(master) ✗ node app.js

This utility will walk you through creating a package.json file.
It only covers the most common items, and tries to guess sensible defaults.

See `npm help json` for definitive documentation on these fields
and exactly what they do.

Use `npm install &lt;pkg&gt; --save` afterwards to install a package and
save it as a dependency in the package.json file.

Press ^C at any time to quit.

name: (name) hello
version: (1.0.0) 0.0.1
author: (none) chyingp</code></pre>
<h2>写在后面</h2>
<p>有不少基于readline的有趣的工具，比如各种脚手架工具。限于篇幅不展开，感兴趣的同学可以研究下。</p>
<h2>相关链接</h2>
<p><a href="https://nodejs.org/api/readline.html">https://nodejs.org/api/rea