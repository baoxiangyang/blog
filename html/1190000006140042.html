端图片压缩上传的功能。期间踩了几个坑，在此总结下。</p>
<p>大体的思路是，部分API的兼容性请参照<a>caniuse</a>：</p>
<ol>
<li><p>利用<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader">FileReader</a>,读取<code>blob对象</code>,或者是<code>file对象</code>，将图片转化为<code>data uri</code>的形式。</p></li>
<li><p>使用<code>canvas</code>,在页面上新建一个画布,利用<code>canvas</code>提供的API,将图片画入这个画布当中。</p></li>
<li><p>利用<code>canvas.toDataURL()</code>，进行图片的压缩，得到图片的<code>data uri</code>的值</p></li>
<li><p>上传文件。</p></li>
</ol>
<p>步骤1当中，在进行图片压缩前，还是对图片大小做了判断的，如果图片大小大于200KB时，是直接进行图片上传，不进行图片的压缩，如果图片的大小是大于200KB，则是先进行图片的压缩再上传:</p>
<pre><code class="javascript">    &lt;input type="file" id="choose" accept="image/*"&gt;</code></pre>
<pre><code class="javascript">    var fileChooser = document.getElementById("choose"),
        maxSize = 200 * 1024;   //200KB
    fileChoose.change = function() {
        var file = this.files[0],   //读取文件
            reader = new FileReader();
            
            reader.onload = function() {
                var result = this.result,   //result为data url的形式
                    img = new Image(),
                    img.src = result;
                    
                    
                if(result.length &lt; maxSize) {  
                    imgUpload(result);      //图片直接上传
                } else {
                    var data = compress(img);    //图片首先进行压缩
                    imgUpload(data);                //图片上传
                }
            }
            
            reader.readAsDataURL(file);
    }</code></pre>
<p>步骤2，3：</p>
<pre><code class="javascript">    var canvas = document.createElement('canvas'),
        ctx = canvas.getContext('2d');
        
    function compress(img) {
        canvas.width = img.width;
        canvas.height = img.height;
        
        //利用canvas进行绘图
        
        //将原来图片的质量压缩到原先的0.2倍。
        var data = canvas.toDataURL('image/jpeg', 0.2); //data url的形式
        
        return data;
    }</code></pre>
<p>在利用canvas进行绘图的过程中,IOS图片上传过程中，存在着这样的问题：</p>
<ol>
<li><p>当你竖着拿手机的时候，拍完照，上传图片时，会出现照片自动旋转的情况，而横着拍照并上传图片时不会出现这个问题。这个时候如果想纠正图片自动旋转的情况，将图片转化为二进制的数据<code>(使用了binaryajax.js)</code>，方便获取图片的<code>exif信息</code>，通过获取<code>exif的信息</code>来确定图片旋转的角度<code>(使用了exif.js)</code>，然后再进行图片相应的旋转处理。<a href="http://bbs.it-home.org/thread-55474-1-1.html">解决方法请戳我</a></p></li>
<li><p>在<code>IOS</code>中，当图片的大小大于 2MB时，会出现图片压扁的情况，这个时候需要重置图片的比例。<a href="http://stackoverflow.com/questions/11929099/html5-canvas-drawimage-ratio-bug-ios">解决方法请戳我</a></p></li>
<li><p>利用FileReader，读取图片的过程需要花费一定时间,将图片数据注入到canvas画布中需要一定时间，图片压缩的过程中，图片越大，CPU计算消耗的时间也越长，可能会出现顿卡的情况。总之，就是这个过程当中需要花费一定时间。</p></li>
<li><p>IOS8.1的版本中有个<code>FileReader</code>的bug: <code>FileReader</code>读取的图片转化为Base64时，字符串为空，<a href="http://stackoverflow.com/questions/25999083/filereader-not-working-on-ios-8">具体的问题描述请戳我</a></p></li>
</ol>
<p>步骤4,文件上传有2种方式:</p>
<ol>
<li><p>将图片转化为base64</p></li>
<li><p>将图片数据转为Blob对象，使用FormData上传文件</p></li>
</ol>
<p>方式1可以通过xhr ajax或者xhr2 FormData进行提交。</p>
<p>方法2这里就有个大坑了。<a href="https://code.google.com/p/android/issues/detail?id=39882">具体描述请戳我</a></p>
<p>简单点说就是：<code>Blob对象</code>是无法注入到<code>FormData对象</code>当中的。</p>
<p>当你拿到了图片的<code>data uri数据</code>后，将其转化为<code>Blob</code>数据类型</p>
<pre><code class="javascript">    var ndata = compress(img);
    ndata = window.atob(ndata); //将base64格式的数据进行解码
    
    //新建一个buffer对象，用以存储图片数据
    var buffer = new Uint8Array(ndata.length);
    for(var i = 0; i &lt; text.length; i++) {
        buffer[i] = ndata.charCodeAt(i);
    }
    
    //将buffer对象转化为Blob数据类型
    var blob = getBlob([buffer]);
    
    var fd = new FormData(),
        xhr = new XMLHttpRequest();
    fd.append('file', blob);
    
    xhr.open('post', url);
    xhr.onreadystatechange = function() {
        //do something
    }
    xhr.send(fd);</code></pre>
<p>在新建<code>Blob对象</code>中有需要进行兼容性的处理，特别是对于不支持<code>FormData</code>上传<code>blob</code>的andriod机的兼容性处理。<a href="https://github.com/gokercebeci/canvasResize">具体的方法请戳我</a><br>主要实现的细节是通过重写HTTP请求。</p>
<hr>
<h2>2月19日更新</h2>
<p>在安卓机器中，部分<code>4.x</code>的机型, 在<code>webview</code>里面对<code>file</code>对象进行了阉割，比如你拿不到<code>file.type</code>的值。</p>
<h2>2月22日更新</h2>
<p><code>Android4.4</code>下<code>&lt;input type="file"&gt;</code>由于系统<code>WebView</code>的<code>openFileChooser</code>接口更改，导致无法选择文件，从而导致无法上传文件. <a href="https://code.google.com/p/android/issues/detail?id=62220">bug描述请戳我</a></p>
<h2><a href="https://github.com/CommanderXL/imgResize">封装好的github