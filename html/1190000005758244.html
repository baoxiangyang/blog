<blockquote><p><a href="https://segmentfault.com/a/1190000005136764">书籍完整目录</a></p></blockquote>
<h1>3.2 Redux TodoApp</h1>
<p><img data-src="/img/bVykcv" src="/img/bVykcv.png"></p>
<p>上一节讲完了 redux 中的概念，但是仍然没有和 react 联系起来，这一节<br>将利用 redux 在 react 中实现完整的 todolist：</p>
<ul>
<li><p>在 react 使用 redux</p></li>
<li><p>通过 Provider 连接 react 和 redux store</p></li>
<li><p>创建 action creators</p></li>
<li><p>创建 reducer</p></li>
<li><p>创建 Container Component</p></li>
<li><p>床架 Dummy Component</p></li>
</ul>
<h2>3.2.1 在 react 使用 redux</h2>
<p>redux 可以和很多第三方的框架结合起来使用，为了在 react 中使用 redux，可以通过 <code>react-redux</code> </p>
<p>安装 <code>react-redux</code></p>
<pre><code class="shell">$ npm install --save react-redux</code></pre>
<h2>3.2.2 通过 Provider 连接 react 和 redux store</h2>
<p>react-redux 提供了一个叫 Provider 的组件，将 react 和 react-redux 结合的方式是用 Provider 嵌套应用的 App 组件，并将 redux store 作为属性传递到 Provider 组件之中。</p>
<p>index.js</p>
<pre><code class="html">import React from 'react'
import { render } from 'react-dom'
import { Provider } from 'react-redux'
import { createStore } from 'redux'
import todoApp from './reducers'
import App from './components/App'

/** store 数据结构 sample
{
  visibilityFilter: 'SHOW_ALL',
  todos: [
    {
      text: 'Consider using Redux',
      completed: true,
    },
    {
      text: 'Keep all state in a single tree',
      completed: false
    }
  ]
}
*/
let store = createStore(todoApp)

render(
  &lt;Provider store={store}&gt;
    &lt;App /&gt;
  &lt;/Provider&gt;,
  document.getElementById('root')
)</code></pre>
<blockquote><p>这里使用到了 React 的 Context ，App 下面的所有组件可以利用 context 获取传入到 Provider 中的 store</p></blockquote>
<h2>3.2.3 创建 action creators</h2>
<p>actions/index.js</p>
<pre><code class="js">let nextTodoId = 0
export const addTodo = (text) =&gt; {
  return {
    type: 'ADD_TODO',
    id: nextTodoId++,
    text
  }
}

export const setVisibilityFilter = (filter) =&gt; {
  return {
    type: 'SET_VISIBILITY_FILTER',
    filter
  }
}

export const toggleTodo = (id) =&gt; {
  return {
    type: 'TOGGLE_TODO',
    id
  }
}</code></pre>
<h2>3.2.4 创建 reducer</h2>
<p>首先创建根 reducer ,通过 <code>redux.combineReducers</code> 方法将其他 reducer 结合起来，每个数据 key 都需要实现一个对应的 reducer</p>
<p>reducer/index.js</p>
<pre><code class="js">import { combineReducers } from 'redux'
import todos from './todos'
import visibilityFilter from './visibilityFilter'

const todoApp = combineReducers({
  todos,
  visibilityFilter
})

export default todoApp</code></pre>
<p>接着是 todos reducer , 需要注意的地方是其中使用 Object.assign 方法保证每次都是返回新的<br>对象</p>
<p>reducer/todos.js</p>
<pre><code class="js">const todo = (state, action) =&gt; {
  switch (action.type) {
    case 'ADD_TODO':
      return {
        id: action.id,
        text: action.text,
        completed: false
      }
    case 'TOGGLE_TODO':
      if (state.id !== action.id) {
        return state
      }

      return Object.assign({}, state, {
        completed: !state.completed
      })

    default:
      return state
  }
}

const todos = (state = [], action) =&gt; {
  switch (action.type) {
    case 'ADD_TODO':
      return [
        ...state,
        todo(undefined, action)
      ]
    case 'TOGGLE_TODO':
      return state.map(t =&gt;
        todo(t, action)
      )
    default:
      return state
  }
}

export default todos</code></pre>
<p>最后是 visibilityFilter </p>
<p>reducers/visibibityFilter.js</p>
<pre><code class="js">const visibilityFilter = (state = 'SHOW_ALL', action) =&gt; {
  switch (action.type) {
    case 'SET_VISIBILITY_FILTER':
      return action.filter
    default:
      return state
  }
}

export default visibilityFilter</code></pre>
<h2>3.2.5  Container Component</h2>
<p>在介绍 flux 的时候介绍过组件分两个类型，smart component 和 dummy component，在 redux 中 Container Component 就是 smart component</p>
<h3>作用</h3>
<p>在 react 应用中，store 的数据只有 container component 能知晓，container component 会将知晓的数据传递给 dummy components ，除此之外 action 的触发方法也会由它传递给 dummy components</p>
<h3>connect 方法</h3>
<p>react-redux 提供了一个叫 connect 的方法，可以将一个组件变为 container component</p>
<pre><code class="js">const ContainerComponent = connect(
    /**
     * 方法将 store 作为参数，返回有个 {key: Value} 对象，key 作为属性传递给 DummyComponent 
     * @type {[type]}
     */
    mapStateToProps: Function,
    /**
     * 方法传递 store.dispatch 作为参数，返回一个{key: Function} 对象，key 作为属性传递给 DummyComponent 
     * @type {[type]}
     */
    mapDispatchToProps: Function
)(DummyComponent)
</code></pre>
<blockquote><p>其本质就是获取react context 中的 store，并将 store 中的数据作为属性传递到原来的组件中</p></blockquote>
<h3>创建 todolist 的 container component</h3>
<p>todolist 会分为三个 container，有个负责 todolist，一个负责 filter，一个为添加 todo，首先是 todolist。</p>
<p>containers/VisibleTodoList.js</p>
<pre><code class="js">import { connect } from 'react-redux'
import { toggleTodo } from '../actions'
import TodoList from '../components/TodoList'

const getVisibleTodos = (todos, filter) =&gt; {
  switch (filter) {
    case 'SHOW_ALL':
      return todos
    case 'SHOW_COMPLETED':
      return todos.filter(t =&gt; t.completed)
    case 'SHOW_ACTIVE':
      return todos.filter(t =&gt; !t.completed)
  }
}

const mapStateToProps = (state) =&gt; {
  return {
    todos: getVisibleTodos(state.todos, state.visibilityFilter)
  }
}

const mapDispatchToProps = (dispatch) =&gt; {
  return {
    onTodoClick: (id) =&gt; {
      dispatch(toggleTodo(id))
    }
  }
}

const VisibleTodoList = connect(
  mapStateToProps,
  mapDispatchToProps
)(TodoList)

export default VisibleTodoList</code></pre>
<p>containers/FilterLink.js</p>
<pre><code class="js">import { connect } from 'react-redux'
import { setVisibilityFilter } from '../actions'
import Link from '../components/Link'

const mapStateToProps = (state, ownProps) =&gt; {
  return {
    active: ownProps.filter === state.visibilityFilter
  }
}

const mapDispatchToProps = (dispatch, ownProps) =&gt; {
  return {
    onClick: () =&gt; {
      dispatch(setVisibilityFilter(ownProps.filter))
    }
  }
}

const FilterLink = connect(
  mapStateToProps,
  mapDispatchToProps
)(Link)

export default FilterLink</code></pre>
<p>containers/AddTodo.js</p>
<pre><code>import React from 'react'
import { connect } from 'react-redux'
import { addTodo } from '../actions'

let AddTodo = ({ dispatch }) =&gt; {
  let input

  return (
    &lt;div&gt;
      &lt;form onSubmit={e =&gt; {
        e.preventDefault()
        if (!input.value.trim()) {
          return
        }
        dispatch(addTodo(input.value))
        input.value = ''
      }}&gt;
        &lt;input ref={node =&gt; {
          input = node
        }} /&gt;
        &lt;button type="submit"&gt;
          Add Todo
        &lt;/button&gt;
      &lt;/form&gt;
    &lt;/div&gt;
  )
}
AddTodo = connect()(AddTodo)

export default AddTodo</code></pre>
<h2>3.2.6 负者展现的 Dummy Components</h2>
<p>components/App.js: App.js 连接所有的 Container Components</p>
<pre><code>import React from 'react'
import Footer from './Footer'
import AddTodo from '../containers/AddTodo'
import VisibleTodoList from '../containers/VisibleTodoList'

const App = () =&gt; (
  &lt;div&gt;
    &lt;AddTodo /&gt;
    &lt;VisibleTodoList /&gt;
    &lt;Footer /&gt;
  &lt;/div&gt;
)

export default App</code></pre>
<p>components/TodoList.js: 展现 todos 列表</p>
<pre><code>import React, { PropTypes } from 'react'
import Todo from './Todo'

const TodoList = ({ todos, onTodoClick }) =&gt; (
  &lt;ul&gt;
    {todos.map(todo =&gt;
      &lt;Todo
        key={todo.id}
        {...todo}
        onClick={() =&gt; onTodoClick(todo.id)}
      /&gt;
    )}
  &lt;/ul&gt;
)

TodoList.propTypes = {
  todos: PropTypes.arrayOf(PropTypes.shape({
    id: PropTypes.number.isRequired,
    completed: PropTypes.bool.isRequired,
    text: PropTypes.string.isRequired
  }).isRequired).isRequired,
  onTodoClick: PropTypes.func.isRequired
}

export default TodoList</code></pre>
<p>components/Todo.js</p>
<pre><code>import React, { PropTypes } from 'react'

const Todo = ({ onClick, completed, text }) =&gt; (
  &lt;li
    onClick={onClick}
    style={{
      textDecoration: completed ? 'line-through' : 'none'
    }}
  &gt;
    {text}
  &lt;/li&gt;
)

Todo.propTypes = {
  onClick: PropTypes.func.isRequired,
  completed: PropTypes.bool.isRequired,
  text: PropTypes.string.isRequired
}

export default Todo</code></pre>
<p>components/Link.js</p>
<pre><code>import React, { PropTypes } from 'react'

const Link = ({ active, children, onClick }) =&gt; {
  if (active) {
    return &lt;span&gt;{children}&lt;/span&gt;
  }

  return (
    &lt;a href="#"
       onClick={e =&gt; {
         e.preventDefault()
         onClick()
       }}
    &gt;
      {children}
    &lt;/a&gt;
  )
}

Link.propTypes = {
  active: PropTypes.bool.isRequired,
  children: PropTypes.node.isRequired,
  onClick: PropTypes.func.isRequired
}

export default Link</code></pre>
<p>components/Footer.js</p>
<pre><code>import React from 'react'
import FilterLink from '../containers/FilterLink'

const Footer = () =&gt; (
  &lt;p&gt;
    Show:
    {" "}
    &lt;FilterLink filter="SHOW_ALL"&gt;
      All
    &lt;/FilterLink&gt;
    {", "}
    &lt;FilterLink filter="SHOW_ACTIVE"&gt;
      Active
    &lt;/FilterLink&gt;
    {", "}
    &lt;FilterLink filter="SHOW_COMPLETED"&gt;
      Completed
    &lt;/FilterLink&gt;
  &lt;/p&gt;
)

export default Footer</code></pre>