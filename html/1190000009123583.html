<p>近期公司需要针对分享流程进行优化，其中一点就是<strong>前端H5检测是否安装应用</strong>，来进行不同的判断（下载或直接跳转到app中）。原理很简单：创建一个<strong>iframe</strong>去打开<strong>uri</strong>。如果打开app成功网页进入后台，再切换回来时间会超过2.5s。<strong>利用时间去检测</strong>。下面来看具体实现过程：</p></blockquote>
<h3>你可能会遇到的问题</h3>
<ul>
<li><p>什么是uri，获取uri需要哪些帮助？</p></li>
<li><p>安卓中应用切换到后台， 计时器仍会不断运行有什么解决方法？</p></li>
<li><p>微信中不支持第三方uri,下载应用。怎么解决来完成跳转到自身app。</p></li>
</ul>
<p>都会在文中找到答案。</p>
<h4>uri获取</h4>
<blockquote><p>这里的uri,指得就是通过 Url scheme 来实现的H5与安卓、苹果应用之间的跳转链接。</p></blockquote>
<p>我们需要找到客户端的同事，来获取如下格式的链接。</p>
<pre><code>xx://'跳转页面'/'携带参数'</code></pre>
<blockquote><p>这里给大家简单解释下url scheme。</p></blockquote>
<p>url 就是我们平常理解的链接。<br>scheme 是指url链接中的最初位置，就是上边链接中 ‘xx’的位置。<br>详细介绍可以看这里：<a href="https://sspai.com/post/31500">使用url scheme详解</a></p>
<p>用这个链接我们可以跳转到 应用中的某个页面,并可以携带一定的参数。这个是我们实现这个<strong>功能的前提</strong>哟。</p>
<h4>具体实现</h4>
<h5>第一步：通过iframe打开App</h5>
<blockquote><p>Android平台则各个app厂商差异很大，比如Chrome从25及以后就不再支持通过js触发（非用户点击），所以这里使用iframe src地址等来触发scheme。</p></blockquote>
<pre><code>    //在iframe 中打开APP
    var ifr = document.createElement('iframe');
    ifr.src = openUrl;
    ifr.style.display = 'none';</code></pre>
<h5>第二步： 判断是否安装某应用</h5>
<blockquote><p>原理：若通过url scheme 打开app成功，那么当前h5会进入后台，通过计时器会有明显延迟。利用时间来判断。</p></blockquote>
<pre><code>    //检查app是否打开
    function checkOpen(cb){
        var _clickTime = +(new Date());
        function check(elsTime) {
            if ( elsTime &gt; 3000 || document.hidden || document.webkitHidden) {
                cb(1);
            } else {
                cb(0);
            }
        }
        //启动间隔20ms运行的定时器，并检测累计消耗时间是否超过3000ms，超过则结束
        var _count = 0, intHandle;
        intHandle = setInterval(function(){
            _count++;        
            var elsTime = +(new Date()) - _clickTime;
            if (_count&gt;=100 || elsTime &gt; 3000 ) {
                clearInterval(intHandle);
                check(elsTime);
            }
        }, 20);
    }</code></pre>
<h6>注意：</h6>
<ul>
<li><p>由于安卓手机,页面进入后台，定时器setTimeout仍会不断运行，所以这里使用setInterval,较小间隔时间重复多次。来根据累计时间判断。</p></li>
<li><p>cb为回调函数，根据返回0 or 1来判断是否安装。</p></li>
<li><p>document.hidden对大于4.4webview支持很好，为页面可见性api。</p></li>
</ul>
<h5>第三步：微信中实现打开or下载应用效果</h5>
<blockquote><p>这里使用的是<strong>应用宝微链接</strong>实现。</p></blockquote>
<pre><code> if (callback) {
      //客户端检测微信直接跳应用宝链接
      var browser = BrowserInfo();
      //使用微链接
      var encodeUri = encodeURIComponent('你的uri');

      if (browser.isWeixin) {
        window.location.href = '你的微链url&amp;android_schema='+encodeUri;
      
      }else{
        checkOpen(function(opened){
            callback &amp;&amp; callback(opened);
        });
     
      }
    }</code></pre>
<h6>注意点：</h6>
<ul>
<li><p>微链接是应用宝提供的，可以在后台获取。</p></li>
<li><p>使用微链接<strong>必须</strong>做encodeURIComponent转义。</p></li>
<li><p>链接地址在微链接后拼接一个android_schema参数加你的uri。</p></li>
</ul>
<h5>完整函数</h5>
<pre><code>export const openApp = function(openUrl, callback) {
    //检查app是否打开
    function checkOpen(cb){
        var _clickTime = +(new Date());
        function check(elsTime) {
            if ( elsTime &gt; 3000 || document.hidden || document.webkitHidden) {
                cb(1);
            } else {
                cb(0);
            }
        }
        //启动间隔20ms运行的定时器，并检测累计消耗时间是否超过3000ms，超过则结束
        var _count = 0, intHandle;
        intHandle = setInterval(function(){
            _count++;        
            var elsTime = +(new Date()) - _clickTime;
            if (_count&gt;=100 || elsTime &gt; 3000 ) {
                clearInterval(intHandle);
                check(elsTime);
            }
        }, 20);
    }
   
    //在iframe 中打开APP
    var ifr = document.createElement('iframe');
    ifr.src = openUrl;
    ifr.style.display = 'none';

    if (callback) {
      //客户端检测微信直接跳应用宝链接
      var browser = BrowserInfo();
      //使用微链接
      var encodeUri = encodeURIComponent(openUrl);

      if (browser.isWeixin) {
        window.location.href = '你的微链url&amp;android_schema='+encodeUri;
      }else{
        checkOpen(function(opened){
            callback &amp;&amp; callback(opened);
        });
     
      }
    }
    
    document.body.appendChild(ifr);      
    setTimeout(function() {
        document.body.removeChild(ifr);
    }, 2000);  

}</code></pre>
<h5>其他</h5>
<h6>函数中调用的BrowserInfo是一个简单的客户端检测。具体如下：</h6>
<pre><code>/**
 * 客户端检测
 */
export const BrowserInfo = function() {
  var json = {
    userAgent: navigator.userAgent.toLowerCase(),
    isAndroid: Boolean(navigator.userAgent.match(/android/ig)),
    isIphone: Boolean(navigator.userAgent.match(/iphone|ipod/ig)),
    isIpad: Boolean(navigator.userAgent.match(/ipad/ig)),
    isWeixin: Boolean(navigator.userAgent.match(/MicroMessenger/ig)),
  }
  
  return json;
}</code></pre>
<h6>回调函数的使用</h6>
<blockquote><p>页面中可以通过传递回调函数，来获取返回值；并通过是否传这个参数来做进入页面检测。</p